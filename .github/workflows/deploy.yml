name: Docker Deploy to Beget

on:
  push:
    branches: [main]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. –ö–ª–æ–Ω–∏—Ä—É–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
      - name: üè∑Ô∏è Checkout code
        uses: actions/checkout@v4

      # 2. –°–æ–±–∏—Ä–∞–µ–º Docker-–æ–±—Ä–∞–∑
      - name: üê≥ Build Docker image
        run: |
          cd src/client
          docker build -t betsolver-client:latest .

      # 3. –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±—Ä–∞–∑ –≤ .tar (—á—Ç–æ–±—ã –ø–µ—Ä–µ–¥–∞—Ç—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä)
      - name: üíæ Save Docker image
        run: |
          cd src/client
          docker save -o betsolver-client.tar betsolver-client:latest
          ls -lh

      # 4. –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º SSH-–∫–ª—é—á –¥–ª—è Beget
      - name: üîë Add SSH key
        uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ secrets.BEGET_SSH_KEY }}
          known_hosts: ${{ secrets.KNOWN_HOSTS }}

      # 5. –ö–æ–ø–∏—Ä—É–µ–º –æ–±—Ä–∞–∑ –Ω–∞ —Å–µ—Ä–≤–µ—Ä –∏ –∑–∞–ø—É—Å–∫–∞–µ–º
      - name: üöÄ Deploy to Beget
        run: |
          scp -o StrictHostKeyChecking=no src/client/betsolver-client.tar ${{ secrets.BEGET_USER }}@${{ secrets.BEGET_HOST }}:/tmp/
          ssh -o StrictHostKeyChecking=no ${{ secrets.BEGET_USER }}@${{ secrets.BEGET_HOST }} "
            docker load -i /tmp/betsolver-client.tar
            docker stop betsolver-client || true
            docker rm betsolver-client || true
            docker run -d --name betsolver-client -p 3000:80 betsolver-client:latest
            rm /tmp/betsolver-client.tar
          "